### 任务调度
---

#### 节点组成
`Cloudtask Center` 中心调度服务以环状结构管理集群中的所有节点，所组成的集群按 `Runtime` 划分，每一个 `Runtime` 下的 `N` 个节点组成一个 `hash` 环结构，节点一但成功加入到某个 `Runtime` 后，就将开始分担 `Runtime` 中的部分任务。不是所有的节点都可以被中心调度服务发现，前提是必须在前端 `Runtimes` 管理中为当前 `Runtime` 的 `Servers` 属性加入待发现节点的 IP 地址，否则即便发现节点也会被视为无效，放弃加入集群。 

#### 分配原则

> 默认分配   

所有任务只会在所属 `Runtime` 的工作节点中分配，不会被垮越 `Runtime` 分配，以此来保证统一的运行时环境，若在 `Runtime` 下所有的工作节点都离线或宕机，那么当前 `Runtime` 下所有任务都将处于分配失败状态 `reallocating`，否则任务始终会被分配到某个节点上。

> 局部分配

任务可以根据选择的 `Target Server` 来分配，基于默认分配原则，这些 `Server` 都来至于相同的 `Runtime`，只是范围更小了些，调度器始终在选择的 `Server` 中来分配节点，若 `Target Server` 中的服务器都离线或宕机，那么任务也将处于分配失败状态 `reallocating`。

#### 分配算法

调度器在分配任务时，会根据任务的ID采用`一致性hash`算法来选择工作节点。

#### 调度流程

`Cloudtask Center` 对每一个任务的调度流程是依赖于 `zookeeper` 来协助完成的，它会为每一个 `Runtime` 维护一个任务分配表，并同步到 `zookeeper` 节点上。所有工作节点只会监视自己加入的 `Runtime` 任务分配表节点数据，若版本号发生改变，同时 `key` 是属于自己，那么任务会被工作节点下载并按调度规则定期执行起来。   

一个任务分配表结构如下：

 ``` json
 {
    "jobid": "e7994ade7a32b13b4a51788d",
    "key": "517ae088-779c-4520-b23f-e5f0c341081d",
    "version": 3,
},
{
    "jobid": "72ec7bb9decf1e8ea92ad3da",
    "key": "509794cc-3539-4f58-a4d3-cc02a4f4848f",
    "version": 3,
},
{
    "jobid": "666e3b394cfd1ee1577e72b4",
    "key": "517ae088-779c-4520-b23f-e5f0c341081d",
    "version": 2,
}
 ```
#### 触发调度

- 创建、修改一个任务   
  调度器会根据任务 `ID`，`Runtime`，`Target Server` 来决定分配原则, 此时触发调度后立即同步到任务分配表中，等待工作节点下载执行。   

- 删除一个任务   
  调度器会将该任务从分配表中删除，分配表改变后同样等待工作节点同步执行删除，若任务正在执行会被强制停止。

- 工作节点上下线   
  当有新工作节点被发现时，调度器会对整个 `Runtime` 重新分配一次任务，尽量让新节点分配一些任务；若有节点离线，调度器会检测该节点上已分配的任务，然后重新分配到其余工作节点上，最终分配数据都会同步到任务分配表中。
